<!--pages/metabolism-analysis/metabolism-analysis.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-icon">ğŸ”„</view>
    <view class="loading-text">AIåˆ†æä¸­...</view>
  </view>

  <!-- åˆ†ææŠ¥å‘Š -->
  <view wx:else>
    <!-- æ ‡é¢˜å¡ç‰‡ -->
    <view class="card header-card">
      <view class="header-title">ğŸ§  ä»£è°¢ç‡åˆ†ææŠ¥å‘Š</view>
      <view class="header-subtitle">åŸºäºç§‘å­¦å…¬å¼ä¸çœŸå®æ•°æ®çš„æ™ºèƒ½åˆ†æ</view>
      <view class="header-time">{{report.formattedTime}}</view>
    </view>

    <!-- æ‘˜è¦å¡ç‰‡ -->
    <view class="card summary-card">
      <view class="card-title">ğŸ“‹ åˆ†ææ‘˜è¦</view>
      <view class="summary-list">
        <view class="summary-item" wx:for="{{report.summary}}" wx:key="index">
          {{item}}
        </view>
      </view>
    </view>

    <!-- ä»£è°¢æ•°æ®å¡ç‰‡ -->
    <view class="card metabolism-card">
      <view class="card-title">ğŸ”¥ ä»£è°¢ç‡æ•°æ®</view>
      
      <view class="metabolism-grid">
        <view class="metabolism-item">
          <view class="metabolism-label">å½“å‰BMR</view>
          <view class="metabolism-value primary">{{report.metabolism.currentBMR}}</view>
          <view class="metabolism-unit">kcal/å¤©</view>
          <view class="metabolism-note">Mifflin-St Jeorå…¬å¼</view>
        </view>
        
        <view class="metabolism-item">
          <view class="metabolism-label">ç†è®ºTDEE</view>
          <view class="metabolism-value info">{{report.metabolism.currentTDEE}}</view>
          <view class="metabolism-unit">kcal/å¤©</view>
          <view class="metabolism-note">BMR Ã— æ´»åŠ¨ç³»æ•°</view>
        </view>
        
        <view class="metabolism-item" wx:if="{{report.metabolism.hasActualTDEE}}">
          <view class="metabolism-label">å®é™…TDEE</view>
          <view class="metabolism-value success">{{report.metabolism.actualTDEE}}</view>
          <view class="metabolism-unit">kcal/å¤©</view>
          <view class="metabolism-note">åŸºäºçœŸå®æ•°æ®</view>
        </view>
        
        <view class="metabolism-item">
          <view class="metabolism-label">é¢„æµ‹BMR</view>
          <view class="metabolism-value {{report.metabolism.changeRate < 0 ? 'warning' : 'success'}}">
            {{report.metabolism.predictedBMR}}
          </view>
          <view class="metabolism-unit">kcal/å¤©</view>
          <view class="metabolism-note">7å¤©åé¢„æµ‹</view>
        </view>
      </view>
      
      <!-- TDEEå¯¹æ¯” -->
      <view wx:if="{{report.metabolism.hasActualTDEE}}" class="tdee-comparison">
        <view class="comparison-title">ğŸ“Š TDEEå¯¹æ¯”åˆ†æ</view>
        <view class="comparison-content">
          <view class="comparison-item">
            <view class="comparison-label">ç†è®ºå€¼ä¸å®é™…å€¼å·®å¼‚</view>
            <view class="comparison-value {{report.metabolism.tdeeDifference > 0 ? 'higher' : 'lower'}}">
              {{report.metabolism.tdeeDifference > 0 ? '+' : ''}}{{report.metabolism.tdeeDifference}} kcal ({{report.metabolism.tdeeDifferencePercent}}%)
            </view>
          </view>
          <view class="comparison-note">
            {{report.metabolism.tdeeDifference > 100 ? 'ğŸ’¡ å®é™…ä»£è°¢é«˜äºç†è®ºå€¼ï¼Œå¯èƒ½è¿åŠ¨é‡è¾ƒå¤§æˆ–ä»£è°¢è¾ƒå¿«' : 
              report.metabolism.tdeeDifference < -100 ? 'ğŸ’¡ å®é™…ä»£è°¢ä½äºç†è®ºå€¼ï¼Œå¯èƒ½æ´»åŠ¨é‡è¾ƒå°‘æˆ–ä»£è°¢é€‚åº”' : 
              'âœ… ç†è®ºå€¼ä¸å®é™…å€¼æ¥è¿‘ï¼Œæ•°æ®å‡†ç¡®'}}
          </view>
          <view class="comparison-confidence">
            <text>æ•°æ®ç½®ä¿¡åº¦: {{report.metabolism.actualTDEEConfidence}}%</text>
          </view>
        </view>
      </view>
      
      <!-- ä»£è°¢å˜åŒ– -->
      <view class="metabolism-change">
        <view class="change-title">ğŸ“‰ ä»£è°¢å˜åŒ–è¶‹åŠ¿</view>
        <view class="change-content">
          <view class="change-item">
            <view class="change-label">å˜åŒ–ç‡</view>
            <view class="change-value {{report.metabolism.changeRate < -0.05 ? 'danger' : report.metabolism.changeRate < 0 ? 'warning' : 'success'}}">
              {{report.metabolism.changeRatePercent}}%
            </view>
          </view>
          <view class="change-note">
            {{report.metabolism.changeRate < -0.08 ? 'âš ï¸ ä»£è°¢ä¸‹é™æ˜æ˜¾ï¼Œå»ºè®®è°ƒæ•´å‡é‡ç­–ç•¥' : 
              report.metabolism.changeRate < -0.04 ? 'ğŸ“Š ä»£è°¢è½»åº¦ä¸‹é™ï¼Œå±äºæ­£å¸¸èŒƒå›´' : 
              report.metabolism.changeRate < 0 ? 'âœ… ä»£è°¢ä¿æŒç¨³å®š' : 
              'ğŸ‰ ä»£è°¢æœ‰æ‰€æå‡'}}
          </view>
        </view>
      </view>

      <view class="confidence-bar">
        <view class="confidence-label">é¢„æµ‹ç½®ä¿¡åº¦</view>
        <view class="confidence-progress">
          <view class="confidence-fill" style="width: {{report.metabolism.confidence * 100}}%"></view>
        </view>
        <view class="confidence-value">{{report.metabolism.confidencePercent}}%</view>
      </view>
    </view>

    <!-- ä½“é‡è¶‹åŠ¿é¢„æµ‹ -->
    <view class="card trend-card">
      <view class="card-title">ğŸ“ˆ æœªæ¥7å¤©ä½“é‡è¶‹åŠ¿é¢„æµ‹</view>
      
      <view class="trend-summary">
        <view class="trend-summary-item">
          <view class="trend-label">å½“å‰ä½“é‡</view>
          <view class="trend-value">{{report.weightTrend.summary.currentWeight}}kg</view>
        </view>
        <view class="trend-arrow">â†’</view>
        <view class="trend-summary-item">
          <view class="trend-label">é¢„æµ‹ä½“é‡</view>
          <view class="trend-value {{report.weightTrend.summary.totalChange < 0 ? 'success' : 'warning'}}">
            {{report.weightTrend.summary.predictedWeight}}kg
          </view>
        </view>
        <view class="trend-summary-item">
          <view class="trend-label">é¢„è®¡å˜åŒ–</view>
          <view class="trend-value {{report.weightTrend.summary.totalChange < 0 ? 'success' : 'warning'}}">
            {{report.weightTrend.summary.totalChange > 0 ? '+' : ''}}{{report.weightTrend.summary.totalChange}}kg
          </view>
        </view>
      </view>

      <view class="trend-chart">
        <view class="chart-title">æ¯æ—¥é¢„æµ‹</view>
        <view class="chart-list">
          <view class="chart-item" wx:for="{{report.weightTrend.predictions}}" wx:key="day">
            <view class="chart-day">ç¬¬{{item.day}}å¤©</view>
            <view class="chart-date">{{item.date}}</view>
            <view class="chart-weight">{{item.weight}}kg</view>
            <view class="chart-change {{item.weightChange < 0 ? 'down' : 'up'}}">
              {{item.weightChange > 0 ? '+' : ''}}{{item.weightChange}}kg
            </view>
            <view class="chart-confidence">ç½®ä¿¡åº¦ {{item.confidencePercent}}%</view>
          </view>
        </view>
      </view>

      <view class="trend-assumptions">
        <view class="assumptions-title">ğŸ“‹ é¢„æµ‹å‡è®¾</view>
        <view class="assumptions-grid">
          <view class="assumption-item">
            <view class="assumption-label">å¹³å‡æ‘„å…¥</view>
            <view class="assumption-value">{{report.weightTrend.assumptions.avgCalorieIntake}} kcal</view>
          </view>
          <view class="assumption-item">
            <view class="assumption-label">å¹³å‡è¿åŠ¨</view>
            <view class="assumption-value">{{report.weightTrend.assumptions.avgExerciseCalories}} kcal</view>
          </view>
          <view class="assumption-item">
            <view class="assumption-label">èµ·å§‹BMR</view>
            <view class="assumption-value">{{report.weightTrend.assumptions.startBMR}} kcal</view>
          </view>
          <view class="assumption-item">
            <view class="assumption-label">é¢„æµ‹BMR</view>
            <view class="assumption-value">{{report.weightTrend.assumptions.endBMR}} kcal</view>
          </view>
        </view>
      </view>
    </view>

    <!-- è¶‹åŠ¿å»ºè®® -->
    <view wx:if="{{report.weightTrend.recommendations.length > 0}}" class="card recommendations-card">
      <view class="card-title">ğŸ’¡ è¶‹åŠ¿è°ƒæ•´å»ºè®®</view>
      <view class="recommendations-list">
        <view 
          class="recommendation-item priority-{{item.priority}} type-{{item.type}}" 
          wx:for="{{report.weightTrend.recommendations}}" 
          wx:key="title"
          bindtap="viewRecommendation"
          data-rec="{{item}}">
          <view class="rec-header">
            <view class="rec-icon">
              {{item.type === 'diet' ? 'ğŸ½ï¸' : item.type === 'exercise' ? 'ğŸƒ' : item.type === 'warning' ? 'âš ï¸' : item.type === 'success' ? 'âœ…' : 'ğŸ’¡'}}
            </view>
            <view class="rec-title">{{item.title}}</view>
            <view class="rec-priority">{{item.priority === 'high' ? 'é‡è¦' : item.priority === 'medium' ? 'å»ºè®®' : 'å‚è€ƒ'}}</view>
          </view>
          <view class="rec-content">{{item.content}}</view>
        </view>
      </view>
    </view>

    <!-- å¹³å°æœŸæ£€æµ‹å¡ç‰‡ -->
    <view class="card plateau-card {{report.plateau.detected ? 'plateau-detected' : ''}}">
      <view class="card-title">
        {{report.plateau.detected ? 'ğŸ”´ å¹³å°æœŸé¢„è­¦' : 'âœ… è¿›å±•æ­£å¸¸'}}
      </view>
      
      <view wx:if="{{report.plateau.detected}}" class="plateau-info">
        <view class="plateau-item">
          <view class="plateau-label">æŒç»­æ—¶é—´</view>
          <view class="plateau-value">{{report.plateau.duration}} å¤©</view>
        </view>
        <view class="plateau-item">
          <view class="plateau-label">æ£€æµ‹ç½®ä¿¡åº¦</view>
          <view class="plateau-value">{{report.plateau.confidencePercent}}%</view>
        </view>
      </view>
      
      <view wx:else class="plateau-normal">
        <text>ğŸ‰ å½“å‰å‡é‡è¿›å±•è‰¯å¥½ï¼Œç»§ç»­ä¿æŒï¼</text>
      </view>
    </view>

    <!-- å½±å“å› ç´  -->
    <view wx:if="{{report.metabolism.factors && report.metabolism.factors.length > 0}}" class="card factors-card">
      <view class="card-title">ğŸ“Š å½±å“å› ç´ åˆ†æ</view>
      <view class="factors-list">
        <view class="factor-item {{item.impact}}" wx:for="{{report.metabolism.factors}}" wx:key="name">
          <view class="factor-icon">
            {{item.impact === 'high' ? 'ğŸ”´' : item.impact === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢'}}
          </view>
          <view class="factor-content">
            <view class="factor-name">{{item.name}}</view>
            <view class="factor-value">å½±å“ç¨‹åº¦: {{item.impact === 'high' ? 'é«˜' : item.impact === 'medium' ? 'ä¸­' : 'ä½'}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- çªç ´å»ºè®® -->
    <view wx:if="{{report.plateau.detected && report.plateau.recommendations.length > 0}}" class="card recommendations-card">
      <view class="card-title">ğŸ’¡ çªç ´å¹³å°æœŸå»ºè®®</view>
      <view class="recommendations-list">
        <view 
          class="recommendation-item priority-{{item.priority}}" 
          wx:for="{{report.plateau.recommendations}}" 
          wx:key="title"
          bindtap="viewRecommendation"
          data-rec="{{item}}">
          <view class="rec-header">
            <view class="rec-icon">
              {{item.type === 'diet' ? 'ğŸ½ï¸' : item.type === 'exercise' ? 'ğŸƒ' : 'ğŸ’¡'}}
            </view>
            <view class="rec-title">{{item.title}}</view>
            <view class="rec-priority">{{item.priority === 'high' ? 'é‡è¦' : item.priority === 'medium' ? 'å»ºè®®' : 'å‚è€ƒ'}}</view>
          </view>
          <view class="rec-content">{{item.content}}</view>
        </view>
      </view>
    </view>

    <!-- è¯¦ç»†æ•°æ® -->
    <view class="card detail-card">
      <view class="detail-header" bindtap="toggleDetail">
        <view class="card-title">ğŸ“ˆ è¯¦ç»†æ•°æ®</view>
        <view class="toggle-icon">{{showDetail ? 'â–¼' : 'â–¶'}}</view>
      </view>
      
      <view wx:if="{{showDetail}}" class="detail-content">
        <view class="detail-item">
          <view class="detail-label">æ•°æ®æ¥æº</view>
          <view class="detail-value">æœ€è¿‘30å¤©è®°å½•</view>
        </view>
        <view class="detail-item">
          <view class="detail-label">åˆ†ææ¨¡å‹</view>
          <view class="detail-value">æ¢¯åº¦æå‡æ ‘é›†æˆ</view>
        </view>
        <view class="detail-item">
          <view class="detail-label">ç‰¹å¾æ•°é‡</view>
          <view class="detail-value">10ä¸ªå…³é”®ç‰¹å¾</view>
        </view>
        <view class="detail-item">
          <view class="detail-label">æ¨¡å‹ç‰ˆæœ¬</view>
          <view class="detail-value">v1.0</view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="action-btn primary" bindtap="refreshAnalysis">
        ğŸ”„ åˆ·æ–°åˆ†æ
      </button>
      <button class="action-btn secondary" bindtap="shareReport">
        ğŸ“¤ åˆ†äº«æŠ¥å‘Š
      </button>
    </view>

    <!-- å¿«æ·æ“ä½œ -->
    <view class="card quick-actions-card">
      <view class="card-title">âš¡ å¿«æ·æ“ä½œ</view>
      <view class="quick-actions">
        <view class="quick-action-item" bindtap="goToWeightUpdate">
          <view class="quick-action-icon">âš–ï¸</view>
          <view class="quick-action-text">è®°å½•ä½“é‡</view>
        </view>
        <view class="quick-action-item" bindtap="goToDiet">
          <view class="quick-action-icon">ğŸ½ï¸</view>
          <view class="quick-action-text">è®°å½•é¥®é£Ÿ</view>
        </view>
        <view class="quick-action-item" bindtap="goToExercise">
          <view class="quick-action-icon">ğŸƒ</view>
          <view class="quick-action-text">è®°å½•è¿åŠ¨</view>
        </view>
      </view>
    </view>

    <!-- è¯´æ˜ -->
    <view class="card info-card">
      <view class="info-title">â„¹ï¸ å…³äºåˆ†æ</view>
      <view class="info-text">
        æœ¬åˆ†æåŸºäºæœºå™¨å­¦ä¹ ç®—æ³•ï¼Œç»¼åˆè€ƒè™‘ä½“é‡å˜åŒ–ã€é¥®é£Ÿæ‘„å…¥ã€è¿åŠ¨æ¶ˆè€—ç­‰å¤šä¸ªå› ç´ ï¼Œé¢„æµ‹ä»£è°¢ç‡å˜åŒ–è¶‹åŠ¿ã€‚
        å»ºè®®æ¯å‘¨æ›´æ–°æ•°æ®ä»¥è·å¾—æ›´å‡†ç¡®çš„é¢„æµ‹ã€‚
      </view>
    </view>
  </view>
</view>
